name: ğŸš€ Deploy Performance Agent Website

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy (type any branch name)'
        required: true
        default: 'main'
        type: string
      deploy_mode:
        description: 'Deployment mode'
        required: true
        default: 'website'
        type: choice
        options:
          - website
          - full

env:
  RESOURCE_GROUP: perf-agent-website-rg
  CONTAINER_APP_NAME: perf-agent-website
  ACR_NAME: perfagentwebsite
  IMAGE_NAME: perf-agent-website

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€ Resolve branch & mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ¯ Determine branch & mode
      id: config
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          BRANCH="${{ inputs.branch }}"
          MODE="${{ inputs.deploy_mode }}"
        else
          BRANCH="${{ github.ref_name }}"
          MODE="auto"
        fi
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT
        echo "mode=$MODE"     >> $GITHUB_OUTPUT
        echo "ğŸ“ Branch: $BRANCH | Mode: $MODE"

    # â”€â”€ Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ steps.config.outputs.branch }}
        fetch-depth: 2

    # â”€â”€ Auto-detect mode on push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Auto-detect deploy mode (push only)
      id: detect
      run: |
        MODE="${{ steps.config.outputs.mode }}"
        if [ "$MODE" = "auto" ]; then
          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if echo "$CHANGED" | grep -qE '^(package\.json|package-lock\.json)'; then
            MODE="full"
            echo "ğŸ“¦ package.json changed â†’ full rebuild"
          else
            MODE="website"
            echo "ğŸŒ No dependency changes â†’ website-only deploy"
          fi
        fi
        echo "mode=$MODE" >> $GITHUB_OUTPUT
        echo "âœ… Deploy mode: $MODE"

    # â”€â”€ Azure login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â˜ï¸ Log in to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: ğŸ” Log in to ACR
      run: az acr login --name ${{ env.ACR_NAME }}

    # â”€â”€ Build: website-only (uses Docker layer cache) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ Build image â€” website only (cached node_modules)
      if: steps.detect.outputs.mode == 'website'
      run: |
        IMAGE_TAG="web-$(date +%Y%m%d%H%M%S)"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

        echo "ğŸ—ï¸ Building with layer cache (skip npm install)..."
        docker build \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --cache-from ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          .

        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Website-only image pushed"

    # â”€â”€ Build: full (no cache â€” fresh npm install) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Build image â€” full rebuild (fresh node_modules)
      if: steps.detect.outputs.mode == 'full'
      run: |
        IMAGE_TAG="full-$(date +%Y%m%d%H%M%S)"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_ENV

        echo "ğŸ—ï¸ Building without cache (fresh npm install)..."
        docker build \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG} \
          -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest \
          --no-cache \
          .

        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${IMAGE_TAG}
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Full image pushed"

    # â”€â”€ Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸš€ Deploy to Azure Container Apps
      run: |
        az containerapp update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.image_tag }} \
          --set-env-vars NODE_ENV=production PORT=8000 GITHUB_TOKEN=${{ secrets.GH_RELEASES_TOKEN }}

    - name: ğŸ”§ Configure Ingress
      run: |
        az containerapp ingress update \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --target-port 8000

    # â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ¥ Health check
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)

        echo "â³ Waiting 30s for new revision..."
        sleep 30

        for i in {1..5}; do
          if curl -sf "https://$APP_URL/health" -o /dev/null; then
            echo "âœ… Health check passed!"
            curl -s "https://$APP_URL/health" | jq '.' || true
            break
          fi
          echo "âš ï¸ Attempt $i/5 failed, retrying in 10s..."
          sleep 10
          if [ $i -eq 5 ]; then
            echo "âŒ Health check failed"
            az containerapp logs show \
              --name ${{ env.CONTAINER_APP_NAME }} \
              --resource-group ${{ env.RESOURCE_GROUP }} \
              --tail 20 || true
            exit 1
          fi
        done

    # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœ… Deployment Summary
      if: always()
      run: |
        APP_URL=$(az containerapp show \
          --name ${{ env.CONTAINER_APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn -o tsv)

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Deployment Successful!"
        else
          echo "âŒ Deployment Failed!"
        fi
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "  Branch: ${{ steps.config.outputs.branch }}"
        echo "  Mode:   ${{ steps.detect.outputs.mode }}"
        echo "  Image:  ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ env.image_tag }}"
        echo "  URL:    https://$APP_URL"
        echo "  Health: https://$APP_URL/health"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
